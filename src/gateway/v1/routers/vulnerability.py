import logging
from functools import lru_cache

from fastapi import APIRouter, Depends

from src.gateway.v1.models.filters import VulnerabilityFilter
from src.gateway.v1.models.responses import Vulnerability, CveReport
from src.services.simulation.vulnerability_service import VulnerabilityService

logger = logging.getLogger()


@lru_cache
def vulnerability_service():
    return VulnerabilityService()

router = APIRouter(
    prefix="/vulnerability",
    tags=["vulnerability"],
)


@router.post("/")
async def read_vulnerabilities(
    skip: int = 0,
    limit: int = 100,
    vulnerability_filter: VulnerabilityFilter = VulnerabilityFilter(),
    service: VulnerabilityService = Depends(vulnerability_service),
) -> list[Vulnerability]:
    return service.query(vulnerability_filter=vulnerability_filter, limit=limit, skip=skip)

@router.get("/{cve}")
async def read_vulnerabilities(
    cve: str,
    service: VulnerabilityService = Depends(vulnerability_service),
) -> Vulnerability:
    return service.query_single(cve)


@router.get("/{cve}/report")
async def read_affected_systems(
    cve: str,
    service: VulnerabilityService = Depends(vulnerability_service),
) -> CveReport:
    return service.create_cve_report(cve)
